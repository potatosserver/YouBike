<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta name="google-site-verification" content="9o55RpXAKN7kR9cYHHvHkWuktV3JVcCYF5mt9XZULCY" />
    <meta charset="UTF-8" />
    <meta name="author" content="å“ç¨Ÿéˆ(AndrewCho)">
    <meta name="description" content="ä¸€å€‹å°ˆç‚º YouBike è¨­è¨ˆçš„ç°¡å–®ã€ç¾è§€ä¸”ä½æµé‡ç«™é»æœå°‹å™¨ï¼Œæä¾›å¿«é€ŸæŸ¥è©¢ç«™é»è³‡è¨ŠåŠŸèƒ½ï¼Œæ»¿è¶³å³æ™‚éœ€æ±‚ï¼Œé©åˆæ‰€æœ‰ç”¨æˆ¶ä½¿ç”¨ã€‚">
    <meta name="keywords" content="YouBike, youBike, YouBike2.0, youBike2.0, ubike, ibike, obike, kbike, å¾®ç¬‘å–®è»Šï¼Œå…¬å…±è‡ªè¡Œè»Š, è…³è¸è»Šï¼ŒYouBikeç«™é»æœå°‹, ç«™é»æœå°‹, YouBike è³‡è¨Š, YouBikeæ“šé»ï¼Œubikeæ“šé» ï¼Œé™„è¿‘ç«™é», é™„è¿‘YouBikeç«™é», å…¨å°YouBike, å°åŒ—YouBike, æ–°åŒ—YouBike, æ¡ƒåœ’YouBike, æ–°ç«¹YouBike, è‹—æ —YouBike, è‡ºä¸­YouBike, å˜‰ç¾©YouBike , è‡ºå—YouBike, é«˜é›„YouBike, å±æ±YouBike, è‡ºæ±YouBike , YouBikeå³æ™‚è³‡è¨Š, å®šä½åŠŸèƒ½, Github, github.io" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>YouBike ç«™é»æœå°‹ : ä¸€å€‹ç°¡å–®ã€ç¾è§€ã€ä½æµé‡çš„YouBikeç«™é»æœå°‹å™¨</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="manifest" href="/YouBike/manifest.json" />
    <link rel="icon" type="image/x-icon" href="https://potatosserver.github.io/YouBike/icons/icon.ico" />
    <!-- åŠ å…¥ Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <style>
      body {
        font-family: 'Noto Sans TC', Arial, sans-serif;
        margin: 0; /* Remove default body margin */
        background: #f4f4f4; /* Default light mode background */
        color: #333; /* Default light mode text color */
        transition: background 0.5s ease, color 0.5s ease;
        padding-top: 20px; /* Add padding to the top */
      }
      
      /* å®šä½é€šçŸ¥æ¨£å¼ */
      #locationNotification {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: rgba(255, 193, 7, 0.9);
        color: #000;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 10001;
        opacity: 0;
        transform: translateY(-20px);
        transition: all 0.3s ease;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      
      #locationNotification.show {
        opacity: 1;
        transform: translateY(0);
      }

      #locationNotification.hide {
        opacity: 0;
        transform: translateY(-20px);
      }
      /* ä¸»æ¨™é¡Œå°ˆç”¨æ¨£å¼ï¼Œé¿å…è¢«å…¶ä»– h1 æ¨£å¼è¦†è“‹ */
      .main-title {
        color: #007bff;
        text-align: center;
        margin-bottom: 8px; /* å¾ 12px æ”¹ç‚º 8px */
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        padding: 4px; /* å¾ 6px æ”¹ç‚º 4px */
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 8px;
        display: inline-block;
        font-size: 1.4em; /* åŠ å…¥å­—é«”å¤§å°ç¸®å° */
      }
      body.dark-mode .main-title {
        color: #90CAF9;
      }
      /* Material 3 é¢¨æ ¼çš„æœå°‹æ¬„å®¹å™¨ */
      #searchContainer {
        display: flex;
        align-items: center;
        margin-left: auto;
        margin-right: auto;
        max-width: 500px;
        width: calc(100% - 40px); /* Adjust width for padding */
        position: relative;
        padding: 8px 16px; /* Adjusted internal padding */
        box-sizing: border-box; /* Ensure padding doesn't increase total width */
        background-color: white; /* Default background */
        border-radius: 28px; /* Large rounded corners */
        box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* subtle elevation */
        transition: box-shadow 0.3s ease;
      }

      body.dark-mode #searchContainer {
          background-color: #1e1e1e; /* Dark mode background */
          box-shadow: 0 2px 4px rgba(255, 255, 255, 0.1); /* Dark mode subtle elevation */
      }

      /* Material 3 é¢¨æ ¼çš„æœå°‹è¼¸å…¥æ¡† */
      #keyword {
        padding: 0; /* Remove input's own padding, controlled by container */
        width: calc(100% - 34px); /* Adjust width to leave space for icon and spacing */
        border: none; /* Remove border */
        border-radius: 0; /* Rounded corners controlled by container */
        margin: 0; /* Remove margin */
        font-size: 16px;
        box-shadow: none; /* Shadow controlled by container */
        word-wrap: break-word;
        overflow-wrap: break-word;
        display: block;
        background-color: transparent; /* Transparent background to show container background */
        color: #333; /* Default text color */
      }

      body.dark-mode #keyword {
          color: #ffffff; /* Dark mode text color */
      }

      #keyword::placeholder {
        color: #888; /* Placeholder text color */
      }
      #keyword:focus {
        outline: none; /* Remove default focus outline */
        /* Add Material 3 style focus effect here if needed */
      }

      /* Search icon style (Material Icons) */
      #searchIcon {
        position: static; /* Let icon flow naturally in flex layout */
        margin-left: 10px; /* Spacing between input and icon */
        font-size: 24px; /* Material Icons default size */
        cursor: pointer;
        color: #555; /* Default icon color */
        transition: color 0.3s ease;
        flex-shrink: 0; /* Prevent icon from shrinking */
        display: inline-flex; /* Use flex to center icon */
        align-items: center;
        justify-content: center;
        width: 24px; /* Set width */
        height: 24px; /* Set height */
      }

      body.dark-mode #searchIcon {
          color: #ccc; /* Dark mode icon color */
      }

      #searchIcon:hover {
        color: #007BFF; /* Hover color */
      }

      /* Adjust spacing below the search container */
      #searchContainer + #locationSwitchContainer {
           margin-top: 6px; /* å¾ 10px æ”¹ç‚º 6px */
      }

      #locationSwitchContainer {
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: rgba(255, 255, 255, 0.9);
    padding: 8px 15px;
    border-radius: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(5px);
    transition: all 0.3s ease;
}

body.dark-mode #locationSwitchContainer {
    background-color: rgba(30, 30, 30, 0.9);
    box-shadow: 0 2px 4px rgba(255, 255, 255, 0.1);
}

#locationSwitchText {
    color: #007BFF;
    font-weight: 500;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
    margin-left: 10px;
}

body.dark-mode #locationSwitchText {
    color: #90CAF9;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
}

      #results {
        margin-top: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
        padding: 0 20px; /* Add padding to results container */
      }
      .station {
        background-color: white;
        border: 1px solid #e0e0e0;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 10px;
        width: calc(33% - 20px);
        min-width: 250px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        word-wrap: break-word;
        overflow-wrap: break-word;
        cursor: pointer;
        position: relative;
      }
      .station:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
      }
      .station h3 {
        margin: 0 0 10px 0;
        color: #007BFF;
        font-size: 1.2em;
        word-wrap: break-word;
        overflow-wrap: break-word;
        padding-right: 30px;
      }
      .station p {
        margin: 0 0 5px 0;
        color: #555;
        font-size: 1em;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }
      .station .pin-button {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 24px;
        cursor: pointer;
        color: #007BFF;
        transition: transform 0.2s ease, color 0.2s ease;
        user-select: none;
      }
      .station .pin-button:hover {
        transform: scale(1.2);
        color: #0056b3;
      }
      .station .pin-button.pinned {
        color: #FFD700;
      }
      #loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 20px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 5px;
        font-size: 1.2em;
        z-index: 10;
        display: none;
        opacity: 0;
        transition: opacity 0.5s ease;
        white-space: nowrap;
        width: auto;
      }
      #loading.show {
        opacity: 1;
        display: block;
      }
      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
      }
      .overlay.show {
        display: block;
      }
      .modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        text-align: center;
        display: none;
      }
      .modal.show {
        display: block;
      }
      .modal button {
        margin: 10px auto;
        display: block;
        padding: 10px 20px;
        background-color: #007BFF;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s ease;
      }
      .modal button:hover {
        background-color: #0056b3;
      }
      /* Dark mode styles */
      body.dark-mode {
        background: #333;
        color: #ffffff;
        transition: background 0.5s ease, color 0.5s ease;
      }
      body.dark-mode h1 {
        color: #90CAF9; /* èˆ‡æš—è‰²æ¨¡å¼ç«™é»åç¨±ä¸€è‡´ */
      }
      body.dark-mode #keyword {
        /* In dark mode, keyword background should be transparent to show searchContainer background */
        background-color: transparent;
        color: #ffffff;
        border-color: #90caf9; /* This border-color won't show because border: none */
      }
      body.dark-mode #keyword::placeholder {
         color: #888; /* Adjust placeholder color for dark mode */
      }

       body.dark-mode #searchContainer {
          background-color: #1e1e1e; /* Dark mode container background */
          box-shadow: 0 2px 4px rgba(255,255,255,0.1); /* Dark mode subtle elevation */
      }
       body.dark-mode #searchIcon {
          color: #ccc; /* Dark mode icon color */
      }
      body.dark-mode #searchIcon:hover {
        color: #ffffff; /* White icon on hover in dark mode */
      }
      body.dark-mode button {
        background-color: #90caf9;
        color: #121212;
      }
      body.dark-mode button:hover {
        background-color: #64b5f6;
      }
      body.dark-mode .station {
        background-color: #444;
        border-color: #555;
        color: #ffffff;
      }
      body.dark-mode .station h3 {
        color: #90CAF9;
      }
      body.dark-mode .station p {
        color: #cccccc;
      }
      body.dark-mode .modal {
        background-color: #333;
        color: #ffffff;
      }
      body.dark-mode .overlay {
        background-color: rgba(0, 0, 0, 0.8);
      }
      body.dark-mode #loading {
        background: #ffffff;
        color: #000000;
      }      body.dark-mode #loadingOverlay {
        background-color: rgba(51, 51, 51, 1);
      }
      body.dark-mode #loadingText {
        color: #ffffff;
      }
      body.dark-mode #noticeBox {
        background-color: #000;
        color: #000;
        border: 1px solid #444;
      }
      #toggleDarkMode {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #007BFF, #0056b3);
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        transition: background 0.3s ease, transform 0.2s ease;
      }
      #toggleDarkMode:hover {
        background: linear-gradient(135deg, #0056b3, #003f7f);
        transform: scale(1.1);
      }
      body.dark-mode #toggleDarkMode {
        background: linear-gradient(135deg, #90caf9, #64b5f6);
        color: #121212;
      }
      body.dark-mode #toggleDarkMode:hover {
        background: linear-gradient(135deg, #64b5f6, #42a5f5);
      }
      /* æ–°å¢åœ°åœ–èˆ‡æµ®å‹•å¡ç‰‡æ¨£å¼ */
      #map {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 1;
        touch-action: none; /* é˜²æ­¢é è¨­è§¸æ§è¡Œç‚º */
      }
      #floatingCard {
        position: fixed;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 600px;
        background: rgba(255,255,255,0.95);
        border: 1px solid #ccc;
        border-radius: 10px 10px 0 0;
        padding: 15px;
        box-shadow: 0 -2px 6px rgba(0,0,0,0.3);
        display: none;
        z-index: 2000;
      }
      #floatingCard h4 {
        margin: 0 0 8px 0;
      }      #mainContent {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        height: 40vh;
        min-height: 200px;
        max-height: 85vh;
        z-index: 2;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
        padding-top: 0; /* ç§»é™¤ä¸Šæ–¹ padding */
        overflow-y: auto;
        width: 85%; /* å¾ 94% æ”¹ç‚º 85% */
        max-width: 1000px; /* å¾ 1200px æ”¹ç‚º 1000px */
        margin: 0 auto;
        left: 50%;
        transform: translateX(-50%);
        touch-action: pan-y; /* ä¿®æ”¹ï¼šå…è¨±å‚ç›´æ²å‹• */
        -webkit-overflow-scrolling: touch; /* å¢åŠ ï¼šæä¾› iOS çš„å¹³æ»‘æ²å‹• */
      }

      #mainContent::before {
    content: '';
    display: block;
    height: 24px; /* è¨­å®šé ‚éƒ¨ç©ºé–“é«˜åº¦ */
    background: inherit; /* ç¹¼æ‰¿çˆ¶å…ƒç´ èƒŒæ™¯è‰² */
    position: sticky;
    top: 0;
    z-index: 99;
}

      #mainContent::-webkit-scrollbar {
        display: none;  /* Chrome, Safari and Opera */
      }

      body.dark-mode #mainContent {
        background: #222;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
      }

      /* æ‹–æ›³æ‰‹æŸ„æ¨£å¼ */
      #dragHandle {
        position: sticky;
        top: 8px; /* èª¿æ•´æ©«æ¢åœ¨é ‚éƒ¨ç©ºé–“ä¸­çš„ä½ç½® */
        z-index: 100;
        height: 20px; /* å¢åŠ å¯é»æ“Šå€åŸŸ */
        cursor: ns-resize;
        background: transparent;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: -10px 0; /* è² é‚Šè·è®“å¯¦éš›é«˜åº¦ä¸å½±éŸ¿å¸ƒå±€ */
      }

      #dragHandle::before {
        content: '';
        width: 40px;
        height: 4px;
        background: #ccc;
        border-radius: 2px;
      }

      body.dark-mode #dragHandle::before {
        background: #666;
      }

      @media (max-width: 768px) {
        #mainContent {
          width: 80%; /* å¾ 92% æ”¹ç‚º 80% */
        }
      }

      @media (max-width: 480px) {
        #mainContent {
          width: 100%;
          padding: 0; /* ç§»é™¤ä¸Šä¸‹ padding */
          max-width: none;
        }
        /* ç§»é™¤ results çš„å·¦å³ padding */
        #results {
          padding: 0 16px; /* æ”¹ç‚ºå›ºå®šçš„å·¦å³ padding */
        }
        /* ç§»é™¤ station å¡ç‰‡çš„å·¦å³é‚Šè· */
        .station {
          margin: 10px 0; /* åªä¿ç•™ä¸Šä¸‹é‚Šè· */
          width: calc(100% - 32px); /* é…åˆ results çš„ padding */
          border-radius: 10px; /* ä¿æŒåœ“è§’ */
        }
      }      /* Adjustments for narrow screens */
      @media (max-width: 768px) {
        .station {
          width: calc(50% - 20px);
        }
        /* Adjusted search container for horizontal layout */
        #searchContainer {
            /* Removed flex-direction: column; to keep items in a row */
            padding: 8px 12px; /* Adjust padding */
            /* Ensure display: flex and align-items: center; are effective */
        }
        #keyword {
          /* Adjusted width to leave space for the icon */
          width: calc(100% - 34px); /* Assuming 24px icon + 10px margin */
          margin-right: 0;
          margin-bottom: 0; /* No margin-bottom in row layout */
          border-radius: 28px; /* Keep rounded corners like default */
          display: block;
          padding: 0 12px; /* Padding controlled by container */
        }
         #searchIcon {
             position: static; /* Remain in static flow within flex container */
             margin-left: 10px; /* Space between input and icon */
             margin-top: 0; /* No margin-top in row layout */
             align-self: auto; /* Default alignment in flex row */
             /* Ensure font-size, width, height are set for the icon */
             font-size: 24px; /* Material Icons size */
             width: 24px;
             height: 24px;
             display: inline-flex;
             align-items: center;
             justify-content: center;
         }

        button {
          width: 100%;
          border-radius: 0 0 5px 5px;
          display: block;
        }

        #results {
          gap: 10px;
        }
        .station {
          margin-bottom: 10px;
        }
      }
      @media (max-width: 480px) {
        .station {
          width: 100%;
        }
        #searchContainer {
             padding: 10px; /* Smaller screen spacing */
         }
         #keyword {
             /* Adjusted width for smaller screens if needed, keeping room for icon */
             width: calc(100% - 34px); /* Assuming 24px icon + 10px margin */
             padding: 0 10px; /* Padding controlled by container */
         }
         #results {
        /* æ–°å¢å·¦å³å…§é‚Šè· */
        padding-left: 16px;
        padding-right: 16px;
    }
    .station {
        /* ç‚ºå€å¡ŠåŠ å…¥å·¦å³é–“è·ï¼Œä¿æŒ 100% å¯¬åº¦æ™‚å·¦å³ä»æœ‰é–“éš™ */
        margin-left: 8px;
        margin-right: 8px;
    }
      }      #loadingOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 1);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9998;
        transition: opacity 0.5s ease;
      }
      
      /* æ–°å¢é€šçŸ¥æ¨£å¼ */
      #locationNotification {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: rgba(255, 193, 7, 0.9);
        color: #000;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 10001;
        opacity: 0;
        transform: translateY(-20px);
        transition: all 0.3s ease;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      
      #locationNotification.show {
        opacity: 1;
        transform: translateY(0);
      }

      #locationNotification.hide {
        opacity: 0;
        transform: translateY(-20px);
      }

      #loadingContent {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      #loadingText {
        font-size: 1.5em;
        color: #007BFF;
        text-align: center;
      }
      .switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
      }
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 24px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: #007BFF;
      }
      input:checked + .slider:before {
        transform: translateX(26px);
      }
      #githubButton img {
        display: block;
        margin: 0;
        width: 45px;
        height: 45px;
        object-fit: contain;
      }      /* Removed installButton styles */
      /* #installButton { ... } */
      /* #installButton img { ... } */      @keyframes popUp {
          0% { transform: translateX(100%) scale(0.5); opacity: 0; }
          100% { transform: translateX(0) scale(1); opacity: 1; }
      }
      @keyframes popDown {
          0% { transform: translateX(0) scale(1); opacity: 1; }
          100% { transform: translateX(100%) scale(0.5); opacity: 0; }
      }      #extraButtons {
          position: fixed;
          bottom: 120px;
          right: 80px;
          transform: translateX(150%);
          transition: transform 0.5s ease, opacity 0.5s ease;
          display: flex;
          flex-direction: row;
          gap: 10px;
          z-index: 1000;
          opacity: 0;
          pointer-events: none;
      }      #extraButtons.show {
          transform: translateX(0);
          opacity: 1;
          pointer-events: auto;
          animation: popUp 0.5s forwards;
      }
      #extraButtons.hiding {
          animation: popDown 0.5s forwards;
      }
      #extraButtons a {
          width: 50px;
          height: 50px;
          background-color: white;
          color: black;
          border: none;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
          text-decoration: none;
          transition: background-color 0.3s ease;
      }
      #extraButtons a:hover {
          background-color: #f0f0f0;
      }      #settingsPanel {
          position: fixed;
          bottom: 60px;
          right: 80px;
          display: flex;
          flex-direction: row;
          gap: 10px;
          z-index: 1200;
          transform: translateX(100%) scale(0.5);
          opacity: 0;
          transition: all 0.3s ease;
          background: rgba(255, 255, 255, 0.9);
          padding: 10px;
          border-radius: 30px;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
          backdrop-filter: blur(10px);
          pointer-events: none;
      }
      
      #settingsPanel.show {
          transform: translateX(0) scale(1);
          opacity: 1;
          pointer-events: auto;
      }
      
      body.dark-mode #settingsPanel {
          background: rgba(30, 30, 30, 0.9);
      }
      
      #settingsPanel.show {
          transform: translateX(0) scale(1);
          opacity: 1;
          animation: popUpSettings 0.3s forwards;
      }
      
      #darkModeToggle {
          display: none;
      }
      
      #settingsPanel a,
      #settingsPanel button {
          transition: all 0.3s ease;
          box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      }
      
      #settingsPanel a:hover,
      #settingsPanel button:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      }

      /* Settings Panel Animations */
      @keyframes popUpSettings {
          0% { 
              transform: translateX(100%) scale(0.5);
              opacity: 0;
          }
          100% { 
              transform: translateX(0) scale(1);
              opacity: 1;
          }
      }

      @keyframes popDownSettings {
          0% { 
              transform: translateX(0) scale(1);
              opacity: 1;
          }
          100% { 
              transform: translateX(100%) scale(0.5);
              opacity: 0;
          }
      }

      #settingsPanel.hiding {
          animation: popDownSettings 0.3s forwards;
      }
      #updateCountdown {
        white-space: nowrap;
      }

      #mapControls {
        position: fixed;
        top: 8px;
        left: 50%;
        transform: translateX(-50%); /* ä½¿ç”¨ transform ä¾†ç½®ä¸­ */
        z-index: 9000 !important;
        width: 90%;
        max-width: 800px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px; /* å¾ 6px æ”¹ç‚º 4px */
        pointer-events: none; /* å…è¨±é»æ“Šç©¿é€åˆ°åœ°åœ– */
      }

      #mapControls > * {
        pointer-events: auto; /* æ¢å¾©æ§åˆ¶é …çš„é»æ“ŠåŠŸèƒ½ */
      }

      #mapControls h1 {
        color: #007BFF;
        background-color: transparent;
        display: inline;
        padding: 0;
      }

      body.dark-mode #mapControls h1 {
        color: #90CAF9;
        text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
      }

      /* ä¿®æ”¹ï¼šåƒ…ç•¶ body æœ‰ dark-mode é¡åˆ¥æ™‚ï¼Œå°‡æ¿¾é¡å¥—ç”¨æ–¼åœ°åœ–å±¤èˆ‡æ§åˆ¶é … */
      body.dark-mode .leaflet-layer,
      body.dark-mode .leaflet-control-zoom-in,
      body.dark-mode .leaflet-control-zoom-out,
      body.dark-mode .leaflet-control-attribution {
        filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
      }

      /* å¼·åˆ¶ popup åœ¨æ‰€æœ‰æœå°‹æ¡†å…§å®¹ä¹‹ä¸Š */
      .leaflet-popup-pane {
        z-index: 12000 !important;
      }
      #mapControls, #mapControls * {
        z-index: 9000 !important;
        pointer-events: none !important;
      }
      #mapControls input,
      #mapControls button,
      #mapControls label,
      #mapControls .slider,
      #mapControls #searchIcon {
        pointer-events: auto !important;
      }

      /* æ–°å¢ä¸­å¤®è¨­å®šé¢æ¿æ¨£å¼ */
#centralSettingsPanel {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 80%;
    max-width: 320px;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    z-index: 10000;
    backdrop-filter: blur(10px);
    animation: fadeIn 0.3s ease;
}

body.dark-mode #centralSettingsPanel {
    background: rgba(30, 30, 30, 0.95);
    color: #fff;
}

#centralSettingsPanel h2 {
    text-align: center;
    margin-bottom: 20px;
    color: #007BFF;
    font-size: 1.5em;
}

body.dark-mode #centralSettingsPanel h2 {
    color: #90CAF9;
}

.settings-group {
    margin-bottom: 20px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
}

.settings-group h3 {
    margin-bottom: 15px;
    color: #333;
    font-size: 1.2em;
}

body.dark-mode .settings-group h3 {
    color: #fff;
}

.setting-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 15px;
    padding: 10px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
}

.setting-item label {
    font-size: 1.1em;
}

#closeCentralSettings {
    position: absolute;
    top: 2vh;   /* å¢åŠ ä¸Šé–“è· */
    right: 2vh; /* å¢åŠ å³é–“è· */
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #666;
    padding: 8px;  /* å¢åŠ å…§é–“è· */
    border-radius: 50%;  /* æ–°å¢åœ“å½¢é‚Šæ¡† */
    width: 40px;   /* å›ºå®šå¯¬åº¦ */
    height: 40px;  /* å›ºå®šé«˜åº¦ */
    display: flex;  /* ä½¿ç”¨ flex ç½®ä¸­ */
    align-items: center;
    justify-content: center;
    transition: background-color 0.3s;  /* æ–°å¢éæ¸¡æ•ˆæœ */
}

#closeCentralSettings:hover {
    background-color: rgba(0, 0, 0, 0.1);  /* æ–°å¢æ‡¸åœæ•ˆæœ */
}

body.dark-mode #closeCentralSettings {
    color: #fff;
}

body.dark-mode #closeCentralSettings:hover {
    background-color: rgba(255, 255, 255, 0.1);  /* æš—è‰²æ¨¡å¼æ‡¸åœæ•ˆæœ */
}

@keyframes fadeIn {
    from { opacity: 0; transform: translate(-50%, -48%); }
    to { opacity: 1; transform: translate(-50%, -50%); }
}
    </style>
  </head>
  <body>
    <div id="map"></div>
    <!-- å°‡æœå°‹æ¡†ç§»åˆ°åœ°åœ–å¤–å±¤ï¼Œé¿å… input è“‹ä½ popup -->
    <div id="mapControls">
      <h1 id="heading" class="main-title"></h1>
      <div id="searchContainer">
        <input type="text" id="keyword" placeholder="è«‹è¼¸å…¥ç«™é»åç¨±ã€åœ°å€" value="" />
        <span id="searchIcon" class="material-icons" title="æœå°‹">search</span>
      </div>
      <!-- ç§»é™¤äº† locationSwitchContainer div -->
    </div>
    <!-- åœ°åœ–å…¶ä»–å…§å®¹ç”± leaflet æ§åˆ¶ -->
    <!-- ç§»é™¤ç¨ç«‹çš„ #mapControlsï¼ˆè‹¥æœ‰çš„è©±ï¼‰ -->
    <div id="locationNotification"></div>
    <div id="loadingOverlay">
      <div id="loadingContent">
        <h2 id="loadingText">è¼‰å…¥ä¸­</h2>
        <div id="noticeBox" style="margin-top: 10px; margin-left: 20px; margin-right: 20px; background: #fff; padding: 10px; border: 1px solid #ccc; border-radius: 5px;"></div>
      </div>
    </div>
    <div id="mainContent">
      <div id="dragHandle"></div>
      <div id="results"></div>
      <div id="loading">è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</div>
      <div class="overlay"></div>
      <div class="modal" id="permissionModal">
        <p id="modalText"></p>
        <button id="modalButton">ç¢ºå®š</button>
      </div>
      <div id="extraButtons">
          <a href="https://github.com/potatosserver/YouBike" target="_blank">
              <img loading="lazy" src="https://potatosserver.github.io/YouBike/icons/html.webp" alt="YouBike Repo" style="width:30px; height:30px;" />
          </a>
          <a href="https://github.com/potatosserver/YouBike_Python" target="_blank">
                <img loading="lazy" src="https://potatosserver.github.io/YouBike/icons/python.webp" alt="YouBike Python" style="width:30px; height:30px;" />
          </a>
      </div>
      </div>      <button id="settingsButton" title="è¨­å®š" style="position: fixed; bottom: 60px; right: 20px; z-index: 1200; width: 50px; height: 50px; background: white; color: black; border: 2px solid black; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 24px; transition: transform 0.2s ease;">âš™ï¸</button>
      <div id="settingsPanel">
        <button id="darkModeToggle" title="åˆ‡æ›æš—è‰²æ¨¡å¼">ğŸŒ™</button>
        <button id="langToggle" title="Switch Language" style="width:50px; height:50px; border-radius:50%; margin:0 5px; display:flex; align-items:center; justify-content:center;">
          <img loading="lazy" src="https://potatosserver.github.io/YouBike/icons/translate.webp" alt="Translate" style="width:35px; height:35px;" />
        </button>
        <a id="githubLink" href="https://github.com/KEVIN970712/YouBike" target="_blank" style="width:50px; height:50px; border-radius:50%; margin:0 5px; display:flex; align-items:center; justify-content:center; background:white; text-decoration:none;">
          <img loading="lazy" src="https://potatosserver.github.io/YouBike/icons/github.webp" alt="GitHub" style="width:35px; height:35px;" />
        </a>
        <div id="extraButtons">
          <a href="https://github.com/potatosserver/YouBike" target="_blank">
              <img loading="lazy" src="https://potatosserver.github.io/YouBike/icons/html.webp" alt="YouBike Repo" style="width:30px; height:30px;" />
          </a>
          <a href="https://github.com/potatosserver/YouBike_Python" target="_blank">
                <img loading="lazy" src="https://potatosserver.github.io/YouBike/icons/python.webp" alt="YouBike Python" style="width:30px; height:30px;" />
          </a>
        </div>
      </div>
    </div>
    <!-- æ–°å¢æµ®å‹•å¡ç‰‡ï¼Œç”¨æ–¼é¡¯ç¤ºé‡˜æ¨™è©³ç´°è³‡è¨Š -->
    <div id="floatingCard"></div>
    <button id="updateCountdown" style="display:none; position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); z-index: 1000; padding: 6px 12px; background-color: white; color: #007bff; border: 2px solid #007bff; border-radius: 25px; font-size: 0.8em; box-shadow: 0 2px 6px rgba(0,0,0,0.2); transition: all 0.3s ease; width: 100px;">60ç§’å¾Œæ›´æ–°</button>
    <div id="centralSettingsPanel">
    <button id="closeCentralSettings">Ã—</button>
    <h2 id="settingsPanelTitle">ç³»çµ±è¨­å®š</h2>
    
    <div class="settings-group">
        <h3>åŸºæœ¬è¨­å®š</h3>
        <div class="setting-item">
            <label for="centralLocationToggle">ä½ç½®æœå‹™</label>
            <label class="switch">
                <input type="checkbox" id="centralLocationToggle">
                <span class="slider"></span>
            </label>
        </div>
        <div class="setting-item">
            <label for="centralDarkModeToggle">æ·±è‰²æ¨¡å¼</label>
            <label class="switch">
                <input type="checkbox" id="centralDarkModeToggle">
                <span class="slider"></span>
            </label>
        </div>
        <div class="setting-item">
            <label for="centralLangToggle">ä¸­æ–‡/English</label>
            <label class="switch">
                <input type="checkbox" id="centralLangToggle">
                <span class="slider"></span>
            </label>
        </div>
    </div>

    <div class="settings-group">
        <h3>å¤–éƒ¨é€£çµ</h3>
        <div class="setting-item">
            <a href="https://github.com/potatosserver/YouBike" target="_blank" class="github-link">
                <img src="https://potatosserver.github.io/YouBike/icons/html.webp" alt="HTML Repo" style="width:30px; height:30px;">
                <span>YouBike HTML</span>
            </a>
        </div>
        <div class="setting-item">
            <a href="https://github.com/potatosserver/YouBike_Python" target="_blank" class="github-link">
                <img src="https://potatosserver.github.io/YouBike/icons/python.webp" alt="Python Repo" style="width:30px; height:30px;">
                <span>YouBike Python</span>
            </a>
        </div>
    </div>
</div>
    <script>
      // æ–°å¢å…¨åŸŸè®Šæ•¸
      let leafletMap, markerClusterGroup, tileLayer;
      let userLocation = null;
      let locationMarker = null; // æ–°å¢ä½ç½®æ¨™è¨˜è®Šæ•¸
      let sortingLocked = false;
      let initialLoad = true;
      let locationDenied = false;
      let geolocationErrorMessage = null;
      let dataLoaded = false;
      let hasShownDefaultLocationMessage = false; // æ·»åŠ æ–°çš„æ¨™è¨˜
      const defaultLatitude = 22.6315725;
      const defaultLongitude = 120.3025079;
      const overlay = document.querySelector('.overlay');
      const modal = document.querySelector('.modal');
      const modalText = document.getElementById('modalText');
      const modalButton = document.getElementById('modalButton');
      const resultsDiv = document.getElementById('results');
      const loadingDiv = document.getElementById('loading');
      const keywordInput = document.getElementById('keyword');
      const maxResults = 100;
      const defaultSearchArea = "";
      const pinnedStations = new Set(JSON.parse(localStorage.getItem('pinnedStations') || '[]').map(id => String(id)));
      // ç§»é™¤ useLocationSetting ç›¸é—œä»£ç¢¼
      const useLocation = true; // ç›´æ¥è¨­å®šç‚º true
      
      function togglePinStation(stationId, event) {
        event.stopPropagation();

        const id = String(stationId);

        if (pinnedStations.has(id)) {
          pinnedStations.delete(id);
        } else {
          pinnedStations.add(id);
        }

        try {
          localStorage.setItem('pinnedStations', JSON.stringify([...pinnedStations]));
        } catch (e) {
          console.error('Failed to save pinned stations:', e);
        }

        const pinButton = document.querySelector(`.pin-button[data-id="${id}"]`);
        if (pinButton) {
          const isPinned = pinnedStations.has(id);
          pinButton.classList.toggle('pinned', isPinned);
          pinButton.textContent = isPinned ? 'â˜…' : 'â˜†';
        }

        updateResultsOrder();
      }
      let mainContentShown = false;
      function showMainContent() {
        if (!mainContentShown) {
          const overlay = document.getElementById("loadingOverlay");
          const mainContent = document.getElementById("mainContent");
          const isOffline = !navigator.onLine;
          
          if (isOffline) {
            document.getElementById("loadingText").textContent = 
              currentLang === "en" ? "Loading cached data..." : "è¼‰å…¥å¿«å–è³‡æ–™ä¸­...";
          }
          
          overlay.style.opacity = "0";
          setTimeout(() => {
            overlay.style.display = "none";
            mainContent.style.display = "block";
            document.getElementById('updateCountdown').style.display = 
              isOffline ? "none" : "block";
          }, 500);
          
          mainContentShown = true;
        }
      }
      (function simulateLoadingPercentage() {
        const loadingText = document.getElementById("loadingText");
        let lang = localStorage.getItem("lang") || "zh";
        let prefix = lang === "en" ? "Loading:" : "è¼‰å…¥ä¸­ï¼š";
        let progress = 0;
        let lockedProgress = null;
        loadingTextInterval = setInterval(() => {
          if (!mainContentShown) {
            if (progress < 85) {
              progress++;
              loadingText.textContent = prefix + progress + "%";
            } else {
              if (lockedProgress === null) {
                lockedProgress = 85 + Math.floor(Math.random() * 11);
              }
              loadingText.textContent = prefix + lockedProgress + "%";
            }
          } else {
            clearInterval(loadingTextInterval);
          }
        }, 50);
      })();
      (function showRandomNotice(){
        let lang = localStorage.getItem("lang") || "zh";
        const notices = lang === "en" ? [
              "âŒDo not speed or ride in reverse",
              "âŒDo not change lanes arbitrarily on sidewalks",
              "âŒDo not use your phone while riding",
              "âŒAvoid harsh braking while riding",
              "âœ”ï¸Remember to adjust the seat to a proper height",
              "âœ”ï¸Ensure that both front and rear lights are working",
              "âœ”ï¸Remember to get bicycle accident insurance",
              "âœ”ï¸Take your belongings from the basket"
        ] : [
              "âŒå‹¿è¶…é€Ÿæˆ–é€†å‘é¨ä¹˜",
              "âŒå‹¿éš¨æ„è®Šæ›è»Šé“åœ¨è¡Œäººé“ä¸Šé¨ä¹˜",
              "âŒå‹¿åœ¨è»Šè¼›è¡Œé§›ä¸­ä½¿ç”¨æ‰‹æ©Ÿ",
              "âŒé¨ä¹˜ä¸­å‹¿ç·Šæ€¥ç…è»Š",
              "âœ”ï¸è¨˜å¾—èª¿æ•´åº§å¢Šè‡³é©å®œé«˜åº¦",
              "âœ”ï¸ç¢ºèªå‰å¾Œè»Šç‡ˆåŠŸèƒ½æ­£å¸¸",
              "âœ”ï¸è¨˜å¾—æŠ•ä¿å…¬å…±è‡ªè¡Œè»Šå‚·å®³éšª",
              "âœ”ï¸è¨˜å¾—å¸¶èµ°ç½®ç‰©ç±ƒå…§çš„éš¨èº«ç‰©å“"
        ];
        const randomIndex = Math.floor(Math.random() * notices.length);
        document.getElementById('noticeBox').textContent = notices[randomIndex];
      })();

      let youbikeDataCache = null;

      // IndexedDB æ“ä½œå‡½æ•¸
function openYoubikeDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open('YoubikeDB', 1);
    
    request.onerror = () => reject(request.error);
    request.onsuccess = () => resolve(request.result);
    
    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      
      // å‰µå»ºç«™é»è³‡æ–™å­˜å„²
      if (!db.objectStoreNames.contains('stations')) {
        db.createObjectStore('stations', { keyPath: 'station_no' });
      }
      
      // å‰µå»ºè»Šè¼›è³‡æ–™å­˜å„²
      if (!db.objectStoreNames.contains('vehicles')) {
        const vehicleStore = db.createObjectStore('vehicles', { keyPath: 'station_no' });
        vehicleStore.createIndex('timestamp', 'timestamp');
      }
    };
  });
}

// ä¿å­˜ç«™é»è³‡æ–™åˆ° IndexedDB
async function saveYoubikeDataToDB(stations) {
  try {
    const db = await openYoubikeDB();
    const tx = db.transaction('stations', 'readwrite');
    const store = tx.objectStore('stations');
    
    await Promise.all(stations.map(station => {
      return new Promise((resolve, reject) => {
        const request = store.put(station);
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }));
    
    return true;
  } catch (error) {
    console.error('ä¿å­˜ç«™é»è³‡æ–™å¤±æ•—:', error);
    return false;
  }
}

// å¾ IndexedDB ç²å–ç«™é»è³‡æ–™
async function getYoubikeDataFromDB() {
  try {
    const db = await openYoubikeDB();
    const tx = db.transaction('stations', 'readonly');
    const store = tx.objectStore('stations');
    
    return new Promise((resolve, reject) => {
      const request = store.getAll();
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  } catch (error) {
    console.error('è®€å–ç«™é»è³‡æ–™å¤±æ•—:', error);
    return [];
  }
}

// ä¿å­˜è»Šè¼›è³‡æ–™åˆ° IndexedDB
async function saveVehicleDataToDB(stationNo, data) {
  try {
    const db = await openYoubikeDB();
    const tx = db.transaction('vehicles', 'readwrite');
    const store = tx.objectStore('vehicles');
    
    const vehicleData = {
      station_no: stationNo,
      ...data,
      timestamp: Date.now()
    };
    
    await new Promise((resolve, reject) => {
      const request = store.put(vehicleData);
      request.onsuccess = () => resolve();
      request.onerror = () => reject(request.error);
    });
    
    return true;
  } catch (error) {
    console.error('ä¿å­˜è»Šè¼›è³‡æ–™å¤±æ•—:', error);
    return false;
  }
}

// å¾ IndexedDB ç²å–è»Šè¼›è³‡æ–™
async function getVehicleDataFromDB(stationNo) {
  try {
    const db = await openYoubikeDB();
    const tx = db.transaction('vehicles', 'readonly');
    const store = tx.objectStore('vehicles');
    
    const data = await new Promise((resolve, reject) => {
      const request = store.get(stationNo);
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
    
    // å¦‚æœè³‡æ–™è¶…é30åˆ†é˜å°±è¦–ç‚ºéæœŸ
    if (data && Date.now() - data.timestamp < 30 * 60 * 1000) {
      const result = {};
      result[stationNo] = data;
      return result;
    }
    
    return null;
  } catch (error) {
    console.error('è®€å–è»Šè¼›è³‡æ–™å¤±æ•—:', error);
    return null;
  }
}

// ä¿®æ”¹ searchYouBike å‡½æ•¸é–‹å§‹éƒ¨åˆ†
async function searchYouBike(showLoadingIndicator = true, shouldMoveMap = false) {
  if (showLoadingIndicator) showLoading();
  const keyword = keywordInput.value.trim().toLowerCase();
  try {
    if (!youbikeDataCache) {
      if (navigator.onLine) {
        try {
          const youbikeUrl = "https://apis.youbike.com.tw/json/station-min-yb2.json";
          const response = await fetch(youbikeUrl, {
            headers: {
              'accept': '*/*',
              'accept-language': 'zh-TW,zh;q=0.9',
            }
          });
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          const youbikeData = await response.json();
          youbikeDataCache = Array.isArray(youbikeData)
            ? youbikeData.map(item => ({ ...item, lat: parseFloat(item.lat), lng: parseFloat(item.lng) }))
            : [];
          await saveYoubikeDataToDB(youbikeDataCache);
        } catch (error) {
          console.warn('Failed to fetch online data, trying IndexedDB:', error);
          youbikeDataCache = await getYoubikeDataFromDB();
        }
      } else {
        youbikeDataCache = await getYoubikeDataFromDB();
        showNotification(currentLang === "en" 
          ? "Offline mode: Using cached data" 
          : "é›¢ç·šæ¨¡å¼ï¼šä½¿ç”¨å¿«å–è³‡æ–™");
      }
    }
    let youbikeResults = youbikeDataCache;
    if (keyword) {
      youbikeResults = youbikeResults.filter(station => {
        const stationNameTW = station.name_tw ? station.name_tw.toLowerCase() : '';
        const stationAddressTW = station.address_tw ? station.address_tw.toLowerCase() : '';
        const stationNameEN = station.name_en ? station.name_en.toLowerCase() : '';
        const stationAddressEN = station.address_en ? station.address_en.toLowerCase() : '';
        return stationNameTW.includes(keyword) || stationAddressTW.includes(keyword) ||
               stationNameEN.includes(keyword) || stationAddressEN.includes(keyword);
      });
    }
    youbikeResults = youbikeResults.sort((a, b) => {
      const distA = calculateDistance(
        userLocation ? userLocation.latitude : defaultLatitude,
        userLocation ? userLocation.longitude : defaultLongitude,
        a.lat, a.lng
      );
      const distB = calculateDistance(
        userLocation ? userLocation.latitude : defaultLatitude,
        userLocation ? userLocation.longitude : defaultLongitude,
        b.lat, b.lng
      );
      return distA - distB;
    });
    let limit = keyword ? 50 : 20;
    let usedStations;
    if (!keyword) {
      const pinnedFromLocal = youbikeResults.filter(station => pinnedStations.has(String(station.station_no)));
      const unpinned = youbikeResults.filter(station => !pinnedStations.has(String(station.station_no)));
      pinnedFromLocal.sort((a, b) => {
        const distA = calculateDistance(
          userLocation ? userLocation.latitude : defaultLatitude,
          userLocation ? userLocation.longitude : defaultLongitude,
          a.lat, a.lng
        );
        const distB = calculateDistance(
          userLocation ? userLocation.latitude : defaultLatitude,
          userLocation ? userLocation.longitude : defaultLongitude,
          b.lat, b.lng
        );
        return distA - distB;
      });
      unpinned.sort((a, b) => {
        const distA = calculateDistance(
          userLocation ? userLocation.latitude : defaultLatitude,
          userLocation ? userLocation.longitude : defaultLongitude,
          a.lat, a.lng
        );
        const distB = calculateDistance(
          userLocation ? userLocation.latitude : defaultLatitude,
          userLocation ? userLocation.longitude : defaultLongitude,
          b.lat, b.lng
        );
        return distA - distB;
      });
      usedStations = [...pinnedFromLocal, ...unpinned].slice(0, limit);
    } else {
      usedStations = youbikeResults.slice(0, limit);
      const pinnedList = usedStations.filter(station => pinnedStations.has(String(station.station_no)));
      const nonPinnedList = usedStations.filter(station => !pinnedStations.has(String(station.station_no)));
      pinnedList.sort((a, b) => {
        const distA = calculateDistance(
          userLocation ? userLocation.latitude : defaultLatitude,
          userLocation ? userLocation.longitude : defaultLongitude,
          a.lat, a.lng
        );
        const distB = calculateDistance(
          userLocation ? userLocation.latitude : defaultLatitude,
          userLocation ? userLocation.longitude : defaultLongitude,
          b.lat, b.lng
        );
        return distA - distB;
      });
      nonPinnedList.sort((a, b) => {
        const distA = calculateDistance(
          userLocation ? userLocation.latitude : defaultLatitude,
          userLocation ? userLocation.longitude : defaultLongitude,
          a.lat, a.lng
        );
        const distB = calculateDistance(
          userLocation ? userLocation.latitude : defaultLatitude,
          userLocation ? userLocation.longitude : defaultLongitude,
          b.lat, b.lng
        );
        return distA - distB;
      });
      usedStations = [...pinnedList, ...nonPinnedList];
    }
    const isOnline = navigator.onLine;
    let vehData = {};
    const stationIds = usedStations.map(station => String(station.station_no));
    if (isOnline) {
      vehData = await queryVehicleData(stationIds);
    }
    const organizedOutput = usedStations.map(site => {
      const info = {
        id: String(site.station_no),
        name: currentLang === "en" ? site.name_en : site.name_tw,
        coords: [site.lat, site.lng],
        district: currentLang === "en" ? site.district_en : site.district_tw,
        address: currentLang === "en" ? site.address_en : site.address_tw
      };
      const vehicle = isOnline ? (Object.entries(vehData).find(([key]) => key === info.id)?.[1] || {}) : {};
      return { station_info: info, vehicle_info: vehicle };
    });
    organizedOutput.forEach(item => {
      const station = item.station_info;
      const vehicle = item.vehicle_info;
      let card = document.querySelector(`.station[data-id="${station.id}"]`);

      const isPinned = pinnedStations.has(String(station.id));
      const pinButtonHtml = `<span
        class="pin-button ${isPinned ? 'pinned' : ''}"
        data-id="${station.id}"
        onclick="togglePinStation('${station.id}', event)"
      >${isPinned ? 'â˜…' : 'â˜†'}</span>`;
      const distance = calculateDistance(
        userLocation ? userLocation.latitude : defaultLatitude,
        userLocation ? userLocation.longitude : defaultLongitude,
        station.coords[0],
        station.coords[1]
      );
      const displayDistance = distance < 1 ? Math.round(distance * 1000) + (currentLang === "en" ? " m" : " å…¬å°º")
                                           : distance.toFixed(2) + (currentLang === "en" ? " km" : " å…¬é‡Œ");
      const distanceLabel = currentLang === "en" ? "Distance:" : "è·é›¢:";
      const addressLabel = currentLang === "en" ? "Address:" : "åœ°å€:";
      const slotsLabel = currentLang === "en" ? "Available Slots:" : "å¯åœç©ºä½æ•¸:";
      const unknownStation = currentLang === "en" ? "Unknown Station" : "æœªçŸ¥ç«™é»";
      const unknownAddress = currentLang === "en" ? "Unknown Address" : "æœªçŸ¥åœ°å€";
      const unknownValue = currentLang === "en" ? "Unknown" : "æœªçŸ¥";
      const vehicleInfoHtml = isOnline ? `
                    <p>YouBike 2.0: <span class="vehicle_yb2">${vehicle?.available_2_0 !== undefined ? vehicle.available_2_0 : unknownValue}</span></p>
                    <p>YouBike 2.0E: <span class="vehicle_ybe">${vehicle?.available_e !== undefined ? vehicle.available_e : unknownValue}</span></p>
                    <p>${slotsLabel} <span class="vehicle_empty">${vehicle?.empty_spaces !== undefined ? vehicle.empty_spaces : unknownValue}</span></p>
                  ` : '';
      const isDefaultLocation = userLocation && userLocation.latitude === defaultLatitude && userLocation.longitude === defaultLongitude;
      const distanceHTML = !isDefaultLocation ? `<p class="distance">${distanceLabel} ${displayDistance}</p>` : "";
      const cardContent = `
                    ${pinButtonHtml}
                    <h3>${station.name || unknownStation}</h3>
                    ${distanceHTML}
                    <p>${addressLabel} ${station.address || unknownAddress}</p>
                    ${vehicleInfoHtml}
                `;
      if (card) {
        card.innerHTML = cardContent;
        card.dataset.lat = station.coords[0];
        card.dataset.lng = station.coords[1];
        card.style.width = window.innerWidth < 768 ? (window.innerWidth < 480 ? "100%" : "calc(50% - 10px)") : "calc(33% - 14px)";
      } else {
        card = document.createElement('div');
        card.className = 'station';
        card.dataset.id = station.id;
        card.dataset.lat = station.coords[0];
        card.dataset.lng = station.coords[1];
        card.style.width = window.innerWidth < 768 ? (window.innerWidth < 480 ? "100%" : "calc(50% - 10px)") : "calc(33% - 14px)";
        card.innerHTML = cardContent;
        card.addEventListener("click", () => {
          const lat = parseFloat(station.coords[0]), lng = parseFloat(station.coords[1]);
          if (!isNaN(lat) && !isNaN(lng)) {
            window.open(`https://www.google.com/maps?q=${lat},${lng}`, "_blank");
          } else {
            showModal(currentLang === "en" ? "Invalid station coordinates, cannot open map." : "ç«™é»åº§æ¨™ç„¡æ•ˆï¼Œç„¡æ³•é–‹å•Ÿåœ°åœ–ã€‚");
          }
        });
        resultsDiv.appendChild(card);
      }
    });
    const validIds = organizedOutput.map(item => item.station_info.id);
    Array.from(resultsDiv.children).forEach(card => {
      if (!validIds.includes(card.dataset.id)) {
        resultsDiv.removeChild(card);
      }
    });          updateResultsOrder();
    await new Promise(resolve => setTimeout(resolve, 0));

    // æ‰¾åˆ°æœå°‹çµæœä¸­è·é›¢æœ€è¿‘çš„ç«™é»ï¼ˆå·²æŒ‰è·é›¢æ’åºï¼‰
    const stationCards = document.querySelectorAll('.station');
    if (stationCards.length > 0 && shouldMoveMap) {  // åŠ å…¥ shouldMoveMap æ¢ä»¶æª¢æŸ¥
      let nearestStation = null;
      let minDistance = Infinity;
      
      stationCards.forEach(card => {
        const lat = parseFloat(card.dataset.lat);
        const lng = parseFloat(card.dataset.lng);
        const distance = calculateDistance(
          userLocation ? userLocation.latitude : defaultLatitude,
          userLocation ? userLocation.longitude : defaultLongitude,
          lat,
          lng
        );
        
        if (distance < minDistance) {
          minDistance = distance;
          nearestStation = card;
        }
      });

      if (nearestStation) {
        const lat = parseFloat(nearestStation.dataset.lat);
        const lng = parseFloat(nearestStation.dataset.lng);
        if (!isNaN(lat) && !isNaN(lng) && leafletMap) {
          leafletMap.setView([lat, lng], 18, { // ç”±16è®Šæ›´ç‚º18
            animate: true,
            duration: 1
          });
        }
      }
    }

    // æ›´æ–°åœ°åœ–é‡˜æ¨™ä½†ä¸ç§»å‹•è¦–åœ–
    updateMapMarkers();

    dataLoaded = true;
    if (showLoadingIndicator) {
      showMainContent();
    }
  } catch (error) {
    console.error("Fetch error:", error);
    resultsDiv.innerHTML = `ç™¼ç”ŸéŒ¯èª¤: ${error.message}`;
  } finally {
    if (showLoadingIndicator) hideLoading();
  }
}
async function queryVehicleData(stationIds) {
  // é™åˆ¶æ‰¹æ¬¡å¤§å°
  if (stationIds.length > 60) {
    stationIds = stationIds.slice(0, 60);
  }

  const allVehicleData = {};
  
  // å¦‚æœé›¢ç·šï¼Œå˜—è©¦å¾ IndexedDB ç²å–è³‡æ–™
  if (!navigator.onLine) {
    for (const stationId of stationIds) {
      const cachedData = await getVehicleDataFromDB(stationId);
      if (cachedData) {
        Object.assign(allVehicleData, cachedData);
      }
    }
    return allVehicleData;
  }

  // åœ¨ç·šæ¨¡å¼ï¼šä½¿ç”¨æ‰¹æ¬¡è«‹æ±‚
  const batchSize = 20;
  const headers = {
    'Accept': '*/*',
    'Content-Type': 'application/json',
    'Origin': 'https://www.youbike.com.tw',
    'Referer': 'https://www.youbike.com.tw/'
  };

  for (let i = 0; i < stationIds.length; i += batchSize) {
    const stationIdBatch = stationIds.slice(i, i + batchSize);
    const body = JSON.stringify({ station_no: stationIdBatch });
    
    try {
      const response = await fetch('https://apis.youbike.com.tw/json/station-bikes.json', {
        method: 'POST',
        headers: headers,
        body: body
      });

      if (!response.ok) throw new Error('Failed to fetch vehicle data');
      
      const data = await response.json();
      Object.assign(allVehicleData, data);

      // å°‡ç²å–çš„è³‡æ–™ä¿å­˜åˆ° IndexedDB
      for (const [stationNo, stationData] of Object.entries(data)) {
        await saveVehicleDataToDB(stationNo, stationData);
      }
    } catch (error) {
      console.error('ç²å–è»Šè¼›è³‡æ–™å¤±æ•—:', error);
      
      // å¦‚æœè«‹æ±‚å¤±æ•—ï¼Œå˜—è©¦å¾å¿«å–ç²å–è³‡æ–™
      for (const stationId of stationIdBatch) {
        const cachedData = await getVehicleDataFromDB(stationId);
        if (cachedData) {
          Object.assign(allVehicleData, cachedData);
        }
      }
    }
  }

  return allVehicleData;
}
function updateResultsOrder() {
  const cards = Array.from(document.querySelectorAll(".station"));
  cards.sort((a, b) => {
    const aPinned = pinnedStations.has(a.dataset.id);
    const bPinned = pinnedStations.has(b.dataset.id);
    if (aPinned && !bPinned) return -1;
    if (!aPinned && bPinned) return 1;
    const distanceA = calculateDistance(
      userLocation ? userLocation.latitude : defaultLatitude,
      userLocation ? userLocation.longitude : defaultLongitude,
      parseFloat(a.dataset.lat),
      parseFloat(a.dataset.lng)
    );
    const distanceB = calculateDistance(
      userLocation ? userLocation.latitude : defaultLatitude,
      userLocation ? userLocation.longitude : defaultLongitude,
      parseFloat(b.dataset.lat),
      parseFloat(b.dataset.lng)
    );
    return distanceA - distanceB;
  });
  cards.forEach(card => {
    resultsDiv.appendChild(card);
  });
}
function showLoading() {
  loadingDiv.classList.add('show');
}
function hideLoading() {
  loadingDiv.classList.remove('show');
}
function showNotification(message) {
    // å°‡æç¤ºè½‰æ›æˆå³ä¸Šè§’é¡¯ç¤ºçš„é€šçŸ¥
    const notification = document.getElementById('locationNotification');
    notification.textContent = message;
    notification.classList.add('show');
    setTimeout(() => {
       notification.classList.remove('show');
    }, 5000);
}

function hideModal() {
    // ä¸å†ä½¿ç”¨ modal æç¤ºï¼Œä¿ç•™ç©ºå‡½å¼
}
function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}      async function handleGeolocationSuccess(position) {
        const wasDefault = !userLocation || (userLocation.latitude === defaultLatitude && userLocation.longitude === defaultLongitude);
        const isFirstLocation = !locationMarker;  // ä½¿ç”¨ locationMarker ä¾†åˆ¤æ–·æ˜¯å¦ç‚ºç¬¬ä¸€æ¬¡å®šä½
        
        userLocation = {
          latitude: position.coords.latitude,
          longitude: position.coords.longitude
        };

        if (leafletMap) {
          // å»ºç«‹æˆ–æ›´æ–°å®šä½æ¨™è¨˜
          if (!locationMarker) {
            // ç¬¬ä¸€æ¬¡å®šä½æ™‚å»ºç«‹æ¨™è¨˜ä¸¦æ·»åŠ è„ˆè¡æ•ˆæœ
            locationMarker = L.circleMarker([userLocation.latitude, userLocation.longitude], {
              radius: 10,
              fillColor: '#2196F3',
              fillOpacity: 0.8,
              color: '#ffffff',
              weight: 3,
              pane: 'markerPane'
            }).addTo(leafletMap);

            // æ·»åŠ è„ˆè¡å‹•ç•«æ•ˆæœ
            const pulsingIcon = L.divIcon({
              className: 'pulsing-icon',
              html: '<div class="pulse"></div>',
              iconSize: [20, 20]
            });
            
            L.marker([userLocation.latitude, userLocation.longitude], {
              icon: pulsingIcon,
              pane: 'markerPane'
            }).addTo(leafletMap);

            // ç¬¬ä¸€æ¬¡å®šä½æ™‚ç§»å‹•åœ°åœ–åˆ°ä½¿ç”¨è€…ä½ç½®
            leafletMap.setView([userLocation.latitude, userLocation.longitude], 18, {
              animate: true,
              duration: 1
            });
          } else {
            // ä¹‹å¾Œåªæ›´æ–°æ¨™è¨˜ä½ç½®
            locationMarker.setLatLng([userLocation.latitude, userLocation.longitude]);
          }
        }
        
        if (wasDefault) {
          await searchYouBike();
          updateResultsOrder();
        } else {
          updateCardDistances();
        }
      }      function handleGeolocationError(error) {
  console.error("Geolocation error:", error);
  locationDenied = true;
  let errorMessage = "";
  let errorType = "";
  let shouldDisableLocationToggle = false; // æ–°å¢è®Šæ•¸æ§åˆ¶æ˜¯å¦è¦é—œé–‰é–‹é—œ
  
  switch (error.code) {
    case error.PERMISSION_DENIED:
      errorMessage = currentLang === "en"
        ? "Location permission denied. The app needs location permission to show nearby stations."
        : "æ‚¨å°šæœªæä¾›å®šä½æ¬Šé™ã€‚éœ€è¦å®šä½æ¬Šé™æ‰èƒ½é¡¯ç¤ºé™„è¿‘ç«™é»ã€‚";
      errorType = "permission";
      shouldDisableLocationToggle = true; // æ¬Šé™è¢«æ‹’çµ•æ™‚é—œé–‰é–‹é—œ
      break;
    case error.POSITION_UNAVAILABLE:
      errorMessage = currentLang === "en"
        ? "Your device doesn't support or has disabled location services. Please check your device settings."
        : "æ‚¨çš„è£ç½®ä¸æ”¯æ´æˆ–å·²åœç”¨å®šä½æœå‹™ï¼Œè«‹æª¢æŸ¥è£ç½®è¨­å®šã€‚";
      errorType = "unavailable";
      shouldDisableLocationToggle = true; // ä¸æ”¯æ´å®šä½æ™‚é—œé–‰é–‹é—œ
      break;
    case error.TIMEOUT:
      errorMessage = currentLang === "en"
        ? "Location request timed out. Please check your internet connection and try again."
        : "å®šä½è«‹æ±‚é€¾æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šå¾Œå†è©¦ä¸€æ¬¡ã€‚";
      errorType = "timeout";
      shouldDisableLocationToggle = false; // å®šä½é€¾æ™‚æ™‚ä¿æŒé–‹é—œç‹€æ…‹
      break;
    default:
      errorMessage = currentLang === "en"
        ? "Unable to get location. Please check your device settings."
        : "ç„¡æ³•å–å¾—ä½ç½®è³‡è¨Šï¼Œè«‹æª¢æŸ¥è£ç½®è¨­å®šã€‚";
      errorType = "unknown";
      shouldDisableLocationToggle = true;
  }

  // æ›´æ–°ä¸­å¤®è¨­å®šé¢æ¿çš„å®šä½é–‹é—œ
  const centralLocationToggle = document.getElementById('centralLocationToggle');
  if (shouldDisableLocationToggle && centralLocationToggle) {
    centralLocationToggle.checked = false;
    localStorage.setItem("useLocation", "false");
  }

  // å¦‚æœå®šä½é–‹é—œé—œé–‰ï¼Œç§»é™¤å®šä½æ¨™è¨˜
  if (!centralLocationToggle?.checked && locationMarker) {
    locationMarker.remove();
    locationMarker = null;
  }

  // åªåœ¨ç¬¬ä¸€æ¬¡é¡¯ç¤ºéŒ¯èª¤æç¤º
  if (!hasShownDefaultLocationMessage) {
    const notification = document.getElementById('locationNotification');
    
    // æ ¹æ“šéŒ¯èª¤é¡å‹è¨­å®šä¸åŒçš„èƒŒæ™¯é¡è‰²
    switch (errorType) {
      case "permission":
        notification.style.backgroundColor = "rgba(244, 67, 54, 0.9)"; // ç´…è‰²
        break;
      case "unavailable":
        notification.style.backgroundColor = "rgba(255, 152, 0, 0.9)"; // æ©™è‰²
        break;
      case "timeout":
        notification.style.backgroundColor = "rgba(255, 193, 7, 0.9)"; // é»ƒè‰²
        break;
      default:
        notification.style.backgroundColor = "rgba(158, 158, 158, 0.9)"; // ç°è‰²
    }
    
    notification.textContent = errorMessage;
    notification.classList.add('show');
    
    setTimeout(() => {
      notification.classList.add('hide');
      setTimeout(() => {
        notification.classList.remove('show', 'hide');
        // é‡ç½®é€šçŸ¥é¡è‰²
        notification.style.backgroundColor = "";
      }, 300);
    }, 5000); // å»¶é•·é¡¯ç¤ºæ™‚é–“åˆ° 5 ç§’

    hasShownDefaultLocationMessage = true;
  }

  userLocation = { latitude: defaultLatitude, longitude: defaultLongitude };
  if (!shouldDisableLocationToggle) {
    searchYouBike();
  }
}      function handleGeoUpdateSuccess(position) {
        // æª¢æŸ¥å®šä½é–‹é—œæ˜¯å¦é–‹å•Ÿ
        const centralLocationToggle = document.getElementById('centralLocationToggle');
        if (!centralLocationToggle?.checked) {
          return; // å¦‚æœé–‹é—œé—œé–‰ï¼Œä¸è™•ç†å®šä½æ›´æ–°
        }
        
        const wasDefault = userLocation && userLocation.latitude === defaultLatitude && userLocation.longitude === defaultLongitude;
        userLocation = {
          latitude: position.coords.latitude,
          longitude: position.coords.longitude
        };
        
        // æ›´æ–°ä½ç½®æ¨™è¨˜
        if (locationMarker) {
          locationMarker.setLatLng([userLocation.latitude, userLocation.longitude]);
        }
        
        if (wasDefault) {
          searchYouBike().then(() => {
            updateResultsOrder();
          });
        } else {
          updateCardDistances();
        }
      }      function handleGeoUpdateError(error) {
        console.error("Geolocation update error:", error);
        // æ–°å¢ï¼šå¦‚æœä½¿ç”¨é è¨­åº§æ¨™å®šä½ï¼Œå‰‡ä¸é¡¯ç¤ºä½¿ç”¨å…ˆå‰åº§æ¨™å®šä½æç¤º
        if (userLocation && userLocation.latitude === defaultLatitude && userLocation.longitude === defaultLongitude) {
          return;
        }
        let errorMessage = currentLang === "en" 
          ? "Unable to update location, continuing with last known position"
          : "ç„¡æ³•æ›´æ–°ä½ç½®ï¼Œå°‡ç¹¼çºŒä½¿ç”¨ä¸Šæ¬¡çš„å®šä½";
        
        const notification = document.getElementById('locationNotification');
        notification.textContent = errorMessage;
        notification.classList.add('show');
        
        setTimeout(() => {
          notification.classList.add('hide');
                                      setTimeout(() => {
            notification.classList.remove('show', 'hide');
          }, 300);
        }, 3000);
      }
      function getLocation() {
        // ç§»é™¤ toggleUseLocation æª¢æŸ¥
        if (navigator.geolocation) {
          let timeoutTriggered = false;
          const geoTimeout = setTimeout(() => {
            timeoutTriggered = true;
            handleGeolocationError({ code: 3, message: "é¦–æ¬¡å®šä½è¶…æ™‚" });
          }, 9998);
          navigator.geolocation.getCurrentPosition(
            function (position) {
              if (!timeoutTriggered) {
                clearTimeout(geoTimeout);
                handleGeolocationSuccess(position);
              }
            },
            function (error) {
              if (!timeoutTriggered) {
                clearTimeout(geoTimeout);
                handleGeolocationError(error);
              }
            },
            {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 0
            }
          );
          setInterval(() => {
            // ç§»é™¤ toggleUseLocation æª¢æŸ¥
            navigator.geolocation.getCurrentPosition(
              handleGeoUpdateSuccess,
              handleGeoUpdateError,
              {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
              }
            );
          }, 10000);
        } else {
          showModal("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†ä½ç½®åŠŸèƒ½ã€‚ç«™é»å°‡ä»¥å°‡ä½¿ç”¨é è¨­åº§æ¨™é€²è¡Œå®šä½ã€‚");
          userLocation = { latitude: defaultLatitude, longitude: defaultLongitude };
          searchYouBike();
          hideLoading();
        }
      }
      function updateCardDistances() {
        const cards = document.querySelectorAll('.station');
        cards.forEach(card => {
          const lat = parseFloat(card.dataset.lat);
          const lng = parseFloat(card.dataset.lng);
          const newDistance = calculateDistance(
            userLocation ? userLocation.latitude : defaultLatitude,
            userLocation ? userLocation.longitude : defaultLongitude,
            lat, lng
          );
          const distanceEl = card.querySelector('.distance');
          if (distanceEl) {
            if (userLocation && userLocation.latitude === defaultLatitude && userLocation.longitude === defaultLongitude) {
              distanceEl.textContent = "";
            } else {
              const distanceLabel = currentLang === "en" ? "Distance:" : "è·é›¢:";
              const unit = newDistance < 1 ? (currentLang === "en" ? " m" : " å…¬å°º") : (currentLang === "en" ? " km" : " å…¬é‡Œ");
              const displayDistance = newDistance < 1 ? Math.round(newDistance * 1000) : newDistance.toFixed(2);
              distanceEl.textContent = distanceLabel + " " + displayDistance + unit;
            }
          }
        });
        updateResultsOrder();
      }
      function updateVehicleData() {
        const stationElements = document.querySelectorAll('.station');
        if (!stationElements.length) return;
        const stationIds = Array.from(stationElements).map(el => el.dataset.id);
        queryVehicleData(stationIds)
          .then(vehicleData => {
            stationElements.forEach(card => {
              const id = card.dataset.id;
              const data = vehicleData[id] || {};
              const yb2El = card.querySelector('.vehicle_yb2');
              const ybeEl = card.querySelector('.vehicle_ybe');
              const emptyEl = card.querySelector('.vehicle_empty');
              if (yb2El) yb2El.textContent = (data.available_2_0 !== undefined ? data.available_2_0 : 'æœªçŸ¥');
              if (ybeEl) ybeEl.textContent = (data.available_e !== undefined ? data.available_e : 'æœªçŸ¥');
              if (emptyEl) emptyEl.textContent = (data.empty_spaces !== undefined ? data.empty_spaces : 'æœªçŸ¥');
            });
            updateResultsOrder();
          })
          .catch(error => {
            console.error("Vehicle data update failed:", error);
          });
      }
      const darkModeToggle = document.getElementById('darkModeToggle');
darkModeToggle.addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains("dark-mode");
    localStorage.setItem("dark_mode", isDark);
    darkModeToggle.innerHTML = isDark ? '<span style="color:#ffd700; font-size:32px;">â˜€ï¸</span>' : 'ğŸŒ™';
    // é‡è¼‰åœ°åœ–ï¼šç§»é™¤ç¾æœ‰åœ°åœ–ä¸¦å‘¼å« initMap() é‡æ–°åˆå§‹åŒ–
    if (leafletMap) {
        leafletMap.remove();
    }
    initMap();
    // åˆ‡æ›æ¨¡å¼å¾Œé‡æ–°èª¿æ•´åœ°åœ–ä½ç½®èˆ‡ç¸®æ”¾
    updateMapMarkers();
});
      if (localStorage.getItem("dark_mode") === "true") {
        document.body.classList.add("dark-mode");
        darkModeToggle.innerHTML = '<span style="color:#ffd700; font-size:32px;">â˜€ï¸</span>';
      }

      let currentLang = localStorage.getItem("lang") || "zh";

      function updateLanguageTexts() {
        document.title = currentLang === "en" ? "YouBike Site Search : A simple, beautiful site search engine" : "YouBike ç«™é»æœå°‹ : ä¸€å€‹ç°¡å–®ã€ç¾è§€ã€ä½æµé‡çš„YouBikeç«™é»æœå°‹å™¨";
        const locationSwitchSpan = document.querySelector('#locationSwitchText');
        if (locationSwitchSpan) {
          locationSwitchSpan.textContent = currentLang === "en" ? "Use Location" : "ä½¿ç”¨å®šä½";
        }
        const heading = document.getElementById('heading');
               if (heading) {
            heading.textContent = currentLang === "en" ? "YouBike Station Search" : "YouBike  ç«™é»æœå°‹";
        }
               const keywordInput = document.getElementById('keyword');
        if (keywordInput) {
          keywordInput.placeholder = currentLang === "en" ? "Please enter station name or address" : "è«‹è¼¸å…¥ç«™é»åç¨±ã€åœ°å€";
        }
               const updateCountdownBtn = document.getElementById('updateCountdown');
        if (updateCountdownBtn) {
          updateCountdownBtn.textContent = currentLang === "en" ? "60 sec update " : "60ç§’å¾Œæ›´æ–°";
        }
        const loadingDiv = document.getElementById('loading');
        if (loadingDiv) {
          loadingDiv.textContent = currentLang === "en" ? "Loading, please wait..." : "è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...";
        }
        // æ–°å¢è¨­å®šé¢æ¿æ–‡å­—æ›´æ–°
        const settingsPanelTitle = document.getElementById('settingsPanelTitle');
        if (settingsPanelTitle) {
          settingsPanelTitle.textContent = currentLang === "en" ? "System Settings" : "ç³»çµ±è¨­å®š";
        }
        const settingGroups = document.querySelectorAll('#centralSettingsPanel .settings-group h3');
        if (settingGroups.length >= 2) {
          settingGroups[0].textContent = currentLang === "en" ? "Basic Settings" : "åŸºæœ¬è¨­å®š";
          settingGroups[1].textContent = currentLang === "en" ? "External Links" : "å¤–éƒ¨é€£çµ";
        }
        // æ›´æ–°åŸºæœ¬è¨­å®šä¸­å„é¸é …æ¨™ç±¤
        const locationLabel = document.querySelector('#centralSettingsPanel .setting-item label[for="centralLocationToggle"]');
        if (locationLabel) {
          locationLabel.textContent = currentLang === "en" ? "Location Service" : "ä½ç½®æœå‹™";
        }
        const darkModeLabel = document.querySelector('#centralSettingsPanel .setting-item label[for="centralDarkModeToggle"]');
        if (darkModeLabel) {
          darkModeLabel.textContent = currentLang === "en" ? "Dark Mode" : "æ·±è‰²æ¨¡å¼";
        }
    }
      updateLanguageTexts();

      const langToggle = document.getElementById('langToggle');
      langToggle.addEventListener('click', (event) => {
        event.stopPropagation();
        currentLang = currentLang === "en" ? "zh" : "en";
        localStorage.setItem("lang", currentLang);
        updateLanguageTexts();
        searchYouBike(false);
      });

      // Initialize settings panel and button
      const settingsButton = document.getElementById('settingsButton');
      const settingsPanel = document.getElementById('settingsPanel');
      
      // Settings button click handler
      settingsButton.addEventListener('click', (event) => {
        event.stopPropagation();
        document.getElementById('centralSettingsPanel').style.display = 'block';
        settingsPanel.classList.remove('show');
      });
      
      // Close settings panel when clicking outside
      document.addEventListener('click', (event) => {
        const panel = document.getElementById('centralSettingsPanel');
        const settingsButton = document.getElementById('settingsButton');
        if (!panel.contains(event.target) && event.target !== settingsButton) {
            panel.style.display = 'none';
        }
      });
      
      // Prevent settings panel from closing when clicking inside it
      settingsPanel.addEventListener('click', (event) => {
        event.stopPropagation();
      });
      // modalButton.addEventListener('click', hideModal);
      window.addEventListener('load', async () => {
        try {
          // æª¢æŸ¥æ˜¯å¦æœ‰ç¶²è·¯é€£ç·š
          if (navigator.onLine) {
            await initMap();
          } else {
            showNotification(currentLang === "en"
              ? "Offline mode: Map features are limited"
              : "é›¢ç·šæ¨¡å¼ï¼šåœ°åœ–åŠŸèƒ½å—é™");
          }

          // å¾ IndexedDB é å…ˆè¼‰å…¥è³‡æ–™
          if (!navigator.onLine) {
            try {
              youbikeDataCache = await getYoubikeDataFromDB();
            } catch (error) {
              console.warn('Failed to load cached data:', error);
            }
          }

          if (centralLocationToggle?.checked) {
            getLocation();
          } else {
            userLocation = { latitude: defaultLatitude, longitude: defaultLongitude };
            await searchYouBike(true, false);
          }
          showMainContent();
        } catch (error) {
          console.error('Initialization error:', error);
          showNotification(currentLang === "en"
            ? "Error initializing app. Some features may be limited."
            : "åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½å—é™ã€‚");
        }
      });

      keywordInput.addEventListener('keypress', function (event) {
        if (event.key === 'Enter') {
          searchYouBike(true, true); // ç§¼å‹•åœ°åœ–
        }
      });


            window.addEventListener('scroll', () => {
        if (settingsPanel.classList.contains('show')) {
            settingsPanel.classList.add('hiding');
           
            setTimeout(() => {
                settingsPanel.classList.remove('show', 'hiding');
            }, 300);
        }
    });
    document.getElementById('heading').addEventListener('click', function() {
    keywordInput.value = '';
    countdownTimer.reset();
    searchYouBike(true, true); // ç§¼å‹•åœ°åœ–
});
const searchIcon = document.getElementById('searchIcon');
searchIcon.addEventListener('click', () => {
  searchYouBike(true, true); // ç§®å‹•åœ°åœ–
});
// ä¿®æ”¹å€’æ•¸è¨ˆæ™‚å™¨ç‰©ä»¶
let countdownTimer = {
    remaining: 60,
    updateButton: document.getElementById('updateCountdown'),
    updateDisplay: function() {
        this.updateButton.textContent = currentLang === "en"
            ? `${this.remaining} sec update `
            : `${this.remaining}ç§’å¾Œæ›´æ–°`;
    },
    reset: function() {
        this.remaining = 60;
        this.updateDisplay();
    },
    update: function() {
        searchYouBike(true, false);  // æ˜ç¢ºè¨­å®šä¸ç§»å‹•åœ°åœ–
        this.reset();
    }
};

// ä¿®æ”¹æ›´æ–°æŒ‰éˆ•çš„äº‹ä»¶ç›£è½å™¨
countdownTimer.updateButton.addEventListener('click', () => {
    countdownTimer.update();  // ä½¿ç”¨æ›´æ–°çš„ update æ–¹æ³•
});

// ä¿®æ”¹è‡ªå‹•æ›´æ–°çš„è¨ˆæ™‚å™¨
setInterval(() => {
    countdownTimer.remaining--;
    if (countdownTimer.remaining <= 0) {
        countdownTimer.update();  // ä½¿ç”¨æ›´æ–°çš„ update æ–¹æ³•
    }
    countdownTimer.updateDisplay();
}, 1000);
      // ä¿®æ”¹å…¨åŸŸè®Šæ•¸
      let allStations = [];
        async function initMap() {
        try {
            // ä½¿ç”¨ä½¿ç”¨è€…ä½ç½®æˆ–é è¨­ä½ç½®åˆå§‹åŒ–åœ°åœ–
            const initialLat = userLocation ? userLocation.latitude : defaultLatitude;
            const initialLng = userLocation ? userLocation.longitude : defaultLongitude;
            
            leafletMap = L.map('map', {
              dragging: true,
              tap: true,
              touchZoom: true,
              doubleClickZoom: true,
              scrollWheelZoom: true,
              zoomControl: true
            }).setView([initialLat, initialLng], 18);

            // å¦‚æœæœ‰ç”¨æˆ¶ä½ç½®ï¼Œç«‹å³å‰µå»ºä½ç½®æ¨™è¨˜
            if (userLocation) {
              locationMarker = L.circleMarker([userLocation.latitude, userLocation.longitude], {
                radius: 10,
                fillColor: '#2196F3',
                fillOpacity: 0.8,
                color: '#ffffff',
                weight: 3,
                pane: 'markerPane'
              }).addTo(leafletMap);
              
              const pulsingIcon = L.divIcon({
                className: 'pulsing-icon',
                html: '<div class="pulse"></div>',
                iconSize: [20, 20]
              });
              
              L.marker([userLocation.latitude, userLocation.longitude], {
                icon: pulsingIcon,
                pane: 'markerPane'
              }).addTo(leafletMap);
            }

            // è¨­ç½® popupPane çš„ z-index
            leafletMap.getPanes().popupPane.style.zIndex = "9999";
            
            // å˜—è©¦è¼‰å…¥åœ°åœ–åœ–å±¤ï¼Œé›¢ç·šæ™‚ä½¿ç”¨å¿«å–
            try {
              tileLayer = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                useCache: true,
                crossOrigin: true
              }).addTo(leafletMap);
            } catch(err) {
              console.warn("Using offline map tiles");
              // é›¢ç·šæ™‚é¡¯ç¤ºåŸºæœ¬åœ°åœ–èƒŒæ™¯
              tileLayer = L.tileLayer('', {
                maxZoom: 19
              }).addTo(leafletMap);
            }

            // åˆå§‹åŒ–ç¾¤é›†æ¨™è¨˜
            markerClusterGroup = L.markerClusterGroup();
            leafletMap.addLayer(markerClusterGroup);
            
            // æ·»åŠ å®šä½æ§åˆ¶æŒ‰éˆ•
            let locateControl = L.control({ position: 'topleft' });
            locateControl.onAdd = function(map) {
              let btn = L.DomUtil.create('button', 'leaflet-bar leaflet-control leaflet-control-custom');
              btn.innerHTML = '<i class="material-icons" style="font-size:18px; line-height:30px;">my_location</i>';
              btn.style.width = '30px';
              btn.style.height = '30px';
              btn.style.display = 'flex';
              btn.style.alignItems = 'center';
              btn.style.justifyContent = 'center';
              btn.style.padding = '0';
              btn.style.cursor = 'pointer';
              btn.title = currentLang === "en" ? "Go to my location" : "å®šä½åˆ°æˆ‘ç›®å‰ä½ç½®";
              
              L.DomEvent.on(btn, 'click', function(e) {
                L.DomEvent.stopPropagation(e);
                L.DomEvent.preventDefault(e);
                if (userLocation) {
                  leafletMap.setView([userLocation.latitude, userLocation.longitude], 18, { animate: true });
                }
              });
              return btn;
            };
            locateControl.addTo(leafletMap);

            // å–å¾—ç«™é»è³‡æ–™ï¼ˆå„ªå…ˆå¾ IndexedDB è®€å–ï¼‰
            let stations = [];
            try {
              if (!navigator.onLine) {
                // é›¢ç·šæ¨¡å¼ï¼šå¾ IndexedDB è®€å–è³‡æ–™
                stations = await getYoubikeDataFromDB();
                if (!stations || stations.length === 0) {
                  throw new Error('No cached data available');
                }
              } else {
                // ç·šä¸Šæ¨¡å¼ï¼šå¾ API ç²å–è³‡æ–™
                const response = await fetch('https://apis.youbike.com.tw/json/station-min-yb2.json', {
                  headers: {
                    'accept': '*/*',
                    'accept-language': 'zh-TW,zh;q=0.9'
                  }
                });
                
                if (!response.ok) throw new Error('ç„¡æ³•å–å¾—ç«™é»è³‡æ–™');
                stations = await response.json();
                
                // æ›´æ–°å¿«å–
                await saveYoubikeDataToDB(stations);
              }
              
              allStations = stations;
              
              // æ·»åŠ ç«™é»æ¨™è¨˜
              stations.forEach(station => {
                const lat = parseFloat(station.lat);
                const lng = parseFloat(station.lng);
                
                if (!isNaN(lat) && !isNaN(lng)) {
                  const marker = L.marker([lat, lng]);
                  
                  marker.on('click', async () => {
                    try {
                      let vehicleData;
                      if (!navigator.onLine) {
                        // é›¢ç·šæ¨¡å¼ï¼šä½¿ç”¨å¿«å–çš„è»Šè¼›è³‡æ–™
                        vehicleData = await getVehicleDataFromDB(station.station_no);
                      } else {
                        // ç·šä¸Šæ¨¡å¼ï¼šå¾ API ç²å–å³æ™‚è³‡æ–™
                        vehicleData = await queryVehicleData([station.station_no]);
                      }
                      
                      const stationInfo = vehicleData[station.station_no] || {};
                      
                      const content = `
                        <h4>${currentLang === "en" ? station.name_en : station.name_tw}</h4>
                        <p>${currentLang === "en" ? "Address: " : "åœ°å€ï¼š"} ${currentLang === "en" ? station.address_en : station.address_tw}</p>
                        <p>YouBike 2.0: ${stationInfo.available_2_0 !== undefined ? stationInfo.available_2_0 : (currentLang === "en" ? 'Unknown' : 'æœªçŸ¥')}</p>
                        <p>YouBike 2.0E: ${stationInfo.available_e !== undefined ? stationInfo.available_e : (currentLang === "en" ? 'Unknown' : 'æœªçŸ¥')}</p>
                        <p>${currentLang === "en" ? "Available Slots: " : "å¯åœç©ºä½æ•¸ï¼š"} ${stationInfo.empty_spaces !== undefined ? stationInfo.empty_spaces : (currentLang === "en" ? 'Unknown' : 'æœªçŸ¥')}</p>
                      `;
                      
                      marker.bindPopup(content).openPopup();
                    } catch (error) {
                      console.error('å–å¾—ç«™é»è³‡è¨Šå¤±æ•—:', error);
                      showNotification(currentLang === "en" ? "Failed to get station information." : "ç„¡æ³•å–å¾—ç«™é»è³‡è¨Šã€‚");
                    }
                  });
                  
                  markerClusterGroup.addLayer(marker);
                }
              });
              
            } catch (error) {
              console.error('åˆå§‹åŒ–ç«™é»è³‡æ–™å¤±æ•—:', error);
              showNotification(currentLang === "en" ? 
                "Failed to load station data. Using cached data if available." : 
                "è¼‰å…¥ç«™é»è³‡æ–™å¤±æ•—ã€‚ä½¿ç”¨å¿«å–è³‡æ–™ï¼ˆå¦‚æœå¯ç”¨ï¼‰ã€‚");
            }
          } catch (error) {
            console.error('åˆå§‹åŒ–åœ°åœ–å¤±æ•—:', error);
            showNotification(currentLang === "en" ? 
              "Failed to initialize map. Some features may be limited." : 
              "åˆå§‹åŒ–åœ°åœ–å¤±æ•—ã€‚éƒ¨åˆ†åŠŸèƒ½å¯èƒ½å—é™ã€‚");
          }
      }
      
      // æ›´æ–°åœ°åœ–é‡˜æ¨™å‡½æ•¸ç¾åœ¨åªéœ€è¦è™•ç†æœå°‹çµæœçš„é«˜äº®é¡¯ç¤º
      function updateMapMarkers() {
        // æª¢æŸ¥æ˜¯å¦é›¢ç·šä¸”åœ°åœ–å…ƒä»¶æœªåˆå§‹åŒ–
        if (!navigator.onLine || !markerClusterGroup) {
          console.log('Map features are limited in offline mode');
          return;
        }

        try {
          // é‡ç½®æ‰€æœ‰é‡˜æ¨™çš„æ¨£å¼
          markerClusterGroup.eachLayer(marker => {
            marker.setIcon(L.icon({
              iconUrl: 'https://unpkg.com/leaflet/dist/images/marker-icon.png',
              iconSize: [25, 41],
              iconAnchor: [12, 41]
            }));
          });
          
          // é«˜äº®é¡¯ç¤ºæœå°‹çµæœçš„é‡˜æ¨™
          const stationCards = document.querySelectorAll('.station');
          stationCards.forEach(card => {
            const lat = parseFloat(card.dataset.lat);
            const lng = parseFloat(card.dataset.lng);
            
            if (markerClusterGroup && typeof markerClusterGroup.eachLayer === 'function') {
              markerClusterGroup.eachLayer(marker => {
                const markerLatLng = marker.getLatLng();
                if (markerLatLng.lat === lat && markerLatLng.lng === lng) {
                  marker.setIcon(L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41]
                  }));
                }
              });
            }
          });
        } catch (error) {
          console.error('Error updating map markers:', error);
          // ä¸ä¸­æ–·æ‡‰ç”¨ç¨‹å¼é‹è¡Œï¼Œåƒ…è¨˜éŒ„éŒ¯èª¤
        }
      }
      
      // åˆå§‹åŒ–åœ°åœ–æ–¼é é¢è¼‰å…¥æ™‚
      window.addEventListener('load', () => {

        initMap();
        if (useLocation) {
          getLocation();
        } else {
          userLocation = { latitude: defaultLatitude, longitude: defaultLongitude };
          searchYouBike(true, false).then(() => {
            showMainContent();
          });
        }
      });
      
      // é»æ“Šé é¢å…¶ä»–å€åŸŸæ™‚ï¼Œéš±è—æµ®å‹•å¡ç‰‡
      document.addEventListener('click', (e) => {
        const floatingCard = document.getElementById('floatingCard');
        if (!e.target.closest('#floatingCard') && floatingCard.style.display === 'block') {
          floatingCard.style.display = 'none';
        }
      });


      // å®Œå…¨é‡å¯«æ‹–æ›±åŠŸèƒ½
      const mainContent = document.getElementById('mainContent');
      const dragHandle = document.getElementById('dragHandle');
      let startY = 0;
      let startHeight = 0;
      let isDragging = false;

      function onStart(e) {
        const touch = e.touches ? e.touches[0] : e;
        startY = touch.clientY;
        startHeight = mainContent.offsetHeight;
        isDragging = true;
        e.preventDefault();
        mainContent.style.transition = 'none';
      }

      function onMove(e) {
        if (!isDragging) return;
        
        const touch = e.touches ? e.touches[0] : e;
        const currentY = touch.clientY;
        const deltaY = startY - currentY;
        const newHeight = Math.min(
          Math.max(startHeight + deltaY, 200),
          window.innerHeight * 0.85
        );
        
        mainContent.style.height = `${newHeight}px`;
      }

      function onEnd() {
        isDragging = false;
        mainContent.style.transition = 'height 0.2s ease';
      }

      // æ»‘é¼ äº‹ä»¶
      dragHandle.addEventListener('mousedown', onStart);
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onEnd);

      // è§¸æ§äº‹ä»¶
      dragHandle.addEventListener('touchstart', onStart, { passive: false });
      document.addEventListener('touchmove', onMove, { passive: true });
      document.addEventListener('touchend', onEnd);
      document.addEventListener('touchcancel', onEnd);

      const darkModeMapStyle = [
        { elementType: 'geometry', stylers: [{ color: '#1d2c4d' }] },
        { elementType: 'labels.text.stroke', stylers: [{ color: '#1a3646' }] },
        { elementType: 'labels.text.fill', stylers: [{ color: '#8ec3b9' }] },
        { featureType: 'administrative', elementType: 'geometry', stylers: [{ color: '#1a3646' }] },
        { featureType: 'administrative.country', elementType: 'labels.text.fill', stylers: [{ color: '#4e6d70' }] },
        { featureType: 'administrative.land_parcel', stylers: [{ visibility: 'off' }] },
        { featureType: 'administrative.locality', elementType: 'labels.text.fill', stylers: [{ color: '#c4d4e0' }] },
        { featureType: 'poi', elementType: 'geometry', stylers: [{ color: '#283d6a' }] },
        { featureType: 'poi', elementType: 'labels.text.fill', stylers: [{ color: '#6f9ba5' }] },
        { featureType: 'poi.park', elementType: 'geometry', stylers: [{ color: '#023e58' }] },
        { featureType: 'poi.park', elementType: 'labels.text.fill', stylers: [{ color: '#3C7680' }] },
        { featureType: 'road', elementType: 'geometry', stylers: [{ color: '#304a7d' }] },
        { featureType: 'road', elementType: 'labels.text.fill', stylers: [{ color: '#98a5be' }] },
        { featureType: 'road', elementType: 'labels.text.stroke', stylers: [{ color: '#1d2c4d' }] },
        { featureType: 'road.highway', elementType: 'geometry', stylers: [{ color: '#2c6675' }] },
        { featureType: 'road.highway', elementType: 'geometry.stroke', stylers: [{ color: '#255763' }] },
        { featureType: 'road.highway', elementType: 'labels.text.fill', stylers: [{ color: '#b0d5ce' }] },
        { featureType: 'road.highway', elementType: 'labels.text.stroke', stylers: [{ color: '#023e58' }] },
        { featureType: 'transit', elementType: 'labels.text.fill', stylers: [{ color: '#98a5be' }] },
        { featureType: 'transit', elementType: 'labels.text.stroke', stylers: [{ color: '#1d2c4d' }] },
        { featureType: 'transit.line', elementType: 'geometry.fill', stylers: [{ color: '#283d6a' }] },
        { featureType: 'transit.station', elementType: 'geometry', stylers: [{ color: '#3a4762' }] },
        { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#0e1626' }] },
        { featureType: 'water', elementType: 'labels.text.fill', stylers: [{ color: '#4e6d70' }] }
      ];

      function initializeMap() {
        const mapOptions = {
          center: { lat: defaultLatitude, lng: defaultLongitude },
          zoom: 14,
          styles: document.body.classList.contains('dark-mode') ? darkModeMapStyle : null,
        };

        const map = new google.maps.Map(document.getElementById('map'), mapOptions);

        // ç¢ºä¿åœ°åœ–å®¹å™¨æœ‰æ­£ç¢ºçš„é«˜åº¦å’Œå¯¬åº¦
        const mapContainer = document.getElementById('map');
        if (mapContainer) {
          mapContainer.style.height = '100vh';
          mapContainer.style.width = '100%';
        }

        // Add a listener to toggle styles when dark mode changes
        const observer = new MutationObserver(() => {
          const isDarkMode = document.body.classList.contains('dark-mode');
          map.setOptions({ styles: isDarkMode ? darkModeMapStyle : null });
        });

        observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });
      }

      // åˆå§‹åŒ–ä¸­å¤®è¨­å®šé¢æ¿
      document.addEventListener('DOMContentLoaded', () => {
        const centralSettingsPanel = document.getElementById('centralSettingsPanel');
        const closeCentralSettings = document.getElementById('closeCentralSettings');
        const centralDarkModeToggle = document.getElementById('centralDarkModeToggle');
        const centralLangToggle = document.getElementById('centralLangToggle');
        const centralLocationToggle = document.getElementById('centralLocationToggle');

        // åˆå§‹åŒ–é–‹é—œç‹€æ…‹
        centralDarkModeToggle.checked = document.body.classList.contains('dark-mode');
        centralLangToggle.checked = currentLang === "en";
        centralLocationToggle.checked = localStorage.getItem("useLocation") === "true";

        // é—œé–‰æŒ‰éˆ•äº‹ä»¶
        closeCentralSettings.addEventListener('click', () => {
          centralSettingsPanel.style.display = 'none';
        });

        // æ·±è‰²æ¨¡å¼é–‹é—œ
        centralDarkModeToggle.addEventListener('change', () => {
          document.body.classList.toggle('dark-mode');
          const isDark = document.body.classList.contains("dark-mode");
          localStorage.setItem("dark_mode", isDark);
          darkModeToggle.innerHTML = isDark ? '<span style="color:#ffd700; font-size:32px;">â˜€ï¸</span>' : 'ğŸŒ™';
          if (leafletMap) {
            leafletMap.remove();
          }
          initMap();
          updateMapMarkers();
        });

        // èªè¨€åˆ‡æ›é–‹é—œ
        centralLangToggle.addEventListener('change', () => {
          currentLang = currentLang === "en" ? "zh" : "en";
          localStorage.setItem("lang", currentLang);
          updateLanguageTexts();
          searchYouBike(false);
          
          // æ›´æ–°è¨­å®šé¢æ¿æ¨™é¡Œ
          document.getElementById('settingsPanelTitle').textContent = 
            currentLang === "en" ? "System Settings" : "ç³»çµ±è¨­å®š";
        });

        // ä½ç½®æœå‹™é–‹é—œ
        centralLocationToggle.addEventListener('change', function() {
          const isChecked = this.checked;
          localStorage.setItem("useLocation", isChecked);
          
          if (isChecked) {
            getLocation();
          } else {
            // é—œé–‰å®šä½æ™‚ç§»é™¤å®šä½æ¨™è¨˜
            if (locationMarker) {
              locationMarker.remove();
              locationMarker = null;
            }
            userLocation = { latitude: defaultLatitude, longitude: defaultLongitude };
            searchYouBike();
          }
        });

        // åˆå§‹åŒ–ä½ç½®æœå‹™é–‹é—œç‹€æ…‹ - é è¨­ç‚ºé–‹å•Ÿ
        if (localStorage.getItem("useLocation") === null) {
          localStorage.setItem("useLocation", "true");
        }
        centralLocationToggle.checked = localStorage.getItem("useLocation") === "true";

        // åˆå§‹åŒ–æ™‚æª¢æŸ¥å®šä½é–‹é—œç‹€æ…‹
        if (centralLocationToggle.checked) {
          getLocation();
        } else {
          userLocation = { latitude: defaultLatitude, longitude: defaultLongitude };
          searchYouBike();
        }
      });
    </script>
    <!-- å¼•å…¥ Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- åŠ å…¥ MarkerCluster çš„ JS -->
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  </body>
</html>