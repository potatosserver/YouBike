<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browser Simulator</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
        }
        #nav-bar {
            display: flex;
            padding: 8px;
            background-color: #f1f1f1;
            border-bottom: 1px solid #ccc;
            gap: 8px;
        }
        #url-input {
            flex-grow: 1;
            padding: 6px 10px;
            border-radius: 14px;
            border: 1px solid #ccc;
            font-size: 14px;
        }
        #go-button {
            padding: 6px 18px;
            border-radius: 14px;
            border: 1px solid #adadad;
            background-color: #e0e0e0;
            cursor: pointer;
            font-weight: 500;
        }
        #go-button:hover {
            background-color: #d6d6d6;
        }
        #content-frame {
            flex-grow: 1;
            border: none;
        }
    </style>
</head>
<body>

    <div id="nav-bar">
        <input type="text" id="url-input" value="https://www.hchs.kh.edu.tw/">
        <button id="go-button">Go</button>
    </div>
    <iframe id="content-frame"></iframe>

    <script>
        // --- Main Application Logic ---
        const urlInput = document.getElementById('url-input');
        const goButton = document.getElementById('go-button');
        const iframe = document.getElementById('content-frame');

        function navigate() {
            let url = urlInput.value.trim();
            // Prepend https:// if no protocol is present
            if (url && !url.match(/^https?:\/\//)) {
                url = 'https://' + url;
                urlInput.value = url;
            }
            if (url) {
                iframe.src = url;
            }
        }

        goButton.addEventListener('click', navigate);
        urlInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                navigate();
            }
        });

        // --- Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            // We use a self-contained Service Worker script via Blob to avoid needing a separate file.
            const serviceWorkerScript = `
                const PROXY_PREFIX = 'https://cors-anywhere.potatosserver.workers.dev/?url=';

                self.addEventListener('fetch', (event) => {
                    const url = event.request.url;

                    // Only proxy http/https requests, and ignore requests to the proxy itself.
                    if (url.startsWith('http') && !url.startsWith(PROXY_PREFIX)) {
                        const proxiedUrl = PROXY_PREFIX + url;

                        const modifiedRequest = new Request(proxiedUrl, {
                            method: event.request.method,
                            headers: event.request.headers,
                            body: event.request.body,
                            redirect: 'follow',
                            mode: 'cors'
                        });
                        
                        event.respondWith(fetch(modifiedRequest));
                    }
                });
            `;
            
            const blob = new Blob([serviceWorkerScript], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);

            navigator.serviceWorker.register(swUrl)
                .then(registration => {
                    console.log('Service Worker registered successfully:', registration.scope);
                    // Reload the page once to ensure the service worker takes control.
                    if (!navigator.serviceWorker.controller) {
                        window.location.reload();
                    }
                })
                .catch(error => {
                    console.error('Service Worker registration failed:', error);
                    alert('Service Worker could not be registered. The browser simulator will not work correctly.');
                });
        } else {
            alert('Your browser does not support Service Workers. This simulator requires a modern browser.');
        }

        // Navigate to the default URL on page load
        window.addEventListener('load', navigate);
    </script>

</body>
</html>